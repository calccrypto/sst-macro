<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>SST/macro: Using DUMPI</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customthing.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">SST/macro
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Using DUMPI </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sec_tutorial_dumpi"></a>
Using DUMPI</h1>
<h2><a class="anchor" id="subset_dump_build"></a>
Building DUMPI</h2>
<p>As noted in the introduction, SST/macro is primarily intended to be an on-line simulator. Real application code runs, but SST/macro intercepts calls to communication (MPI) and computation functions to simulate time passing. However, SST/macro can also run off-line, replaying application traces collected from real production runs. This trace collection and trace replay library is called DUMPI.</p>
<p>Although DUMPI is automatically included as a subproject in the SST/macro download, trace collection can be easier if DUMPI is built independently from SST/macro. The code can be downloaded from <a href="https://bitbucket.org/sst-ca/dumpi">https://bitbucket.org/sst-ca/dumpi</a>. If downloaded through Mercurial, one must initialize the build system and create the configure script.</p>
<div class="fragment"><div class="line">dumpi $ ./bootstrap.sh</div>
</div><!-- fragment --><p>DUMPI must be built with an MPI compiler.</p>
<div class="fragment"><div class="line">dumpi/build $ ../configure CC=mpicc CXX=mpicxx \</div>
<div class="line">                      --enable-libdumpi --prefix=$DUMPI_PATH</div>
</div><!-- fragment --><p> The <code>&ndash;enable-libdumpi</code> flag is needed to configure the trace collection library. After compiling and installing, a <code>libdumpi.$prefix</code> will be added to <code>$DUMPI_PATH/lib</code>.</p>
<p>Collecting application traces requires only a trivial modification to the standard MPI build. Using the same compiler, simply add the DUMPI library path and library name to your project's <code>LDFLAGS</code>.</p>
<div class="fragment"><div class="line">your_project/build $ ../configure CC=mpicc CXX=mpicxx \</div>
<div class="line">                                  LDFLAGS=<span class="stringliteral">&quot;-L$DUMPI_PATH/lib -ldumpi&quot;</span></div>
</div><!-- fragment --><h3><a class="anchor" id="subsec_dumpi_tracecollection"></a>
Trace Collection</h3>
<p>DUMPI works by overriding <em>weak symbols</em> in the MPI library. In all MPI libraries, functions such as <code>MPI_Send</code> are only weak symbol wrappers to the actual function <code>PMPI_Send</code>. DUMPI overrides the weak symbols by implementing functions with the symbol <code>MPI_Send</code>. If a linker encounters a weak symbol and regular symbol with the same name, it ignores the weak symbol. DUMPI functions look like</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> MPI_Send(...)</div>
<div class="line">{<span class="comment"></span></div>
<div class="line"><span class="comment">        /** Start profiling work */</span></div>
<div class="line">        ...</div>
<div class="line">        <span class="keywordtype">int</span> rc = PMPI_Send(...);<span class="comment"></span></div>
<div class="line"><span class="comment">        /** Finish profiling work */</span></div>
<div class="line">        ...</div>
<div class="line">        <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
</div><!-- fragment --><p> collecting profile information and then directly calling the PMPI functions.</p>
<p>We examine DUMPI using a very basic example program.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="mpi_8h.html">mpi.h</a>&gt;</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="libraries_2sumi_2sumi_8h.html#aa4e97f3782107649d3e4eb3875090b3a">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line">{</div>
<div class="line">    MPI_Init(&amp;argc, &amp;argv);</div>
<div class="line">    MPI_Finalize();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p> After compiling the program named <code>test</code> with DUMPI, we run MPI in the standard way.</p>
<div class="fragment"><div class="line">example$ mpiexec -n 2 ./test</div>
</div><!-- fragment --><p> After running, there are now three new files in the directory.</p>
<div class="fragment"><div class="line">example$ ls dumpi*</div>
<div class="line">dumpi-2013.09.26.10.55.53-0000.bin</div>
<div class="line">dumpi-2013.09.26.10.55.53-0001.bin</div>
<div class="line">dumpi-2013.09.26.10.55.53.meta</div>
</div><!-- fragment --><p> DUMPI automatically assigns a unique name to the files from a timestamp. The first two files are the DUMPI binary files storing separate traces for MPI rank 0 and rank 1. The contents of the binary files can be displayed in human-readable form by running the <code>dumpi2ascii</code> program, which should have been installed in <code>$DUMPI_PATH/bin</code>.</p>
<div class="fragment"><div class="line">example$ dumpi2ascii dumpi-2013.09.26.10.55.53-0000.bin</div>
</div><!-- fragment --><p> This produces the output</p>
<div class="fragment"><div class="line">MPI_Init entering at walltime 8153.0493, cputime 0.0044 seconds in thread 0.</div>
<div class="line">MPI_Init returning at walltime 8153.0493, cputime 0.0044 seconds in thread 0.</div>
<div class="line">MPI_Finalize entering at walltime 8153.0493, cputime 0.0045 seconds in thread 0.</div>
<div class="line">MPI_Finalize returning at walltime 8153.0498, cputime 0.0049 seconds in thread 0.</div>
</div><!-- fragment --><p>The third file is just a small metadata file DUMPI used to configure trace replay. </p>
<div class="fragment"><div class="line">hostname=deepthought.magrathea.gov</div>
<div class="line">numprocs=2</div>
<div class="line">username=slartibartfast</div>
<div class="line">startime=1380218153</div>
<div class="line">fileprefix=dumpi-2013.09.26.10.55.53</div>
<div class="line">version=1</div>
<div class="line">subversion=1</div>
<div class="line">subsubversion=0</div>
</div><!-- fragment --><h3><a class="anchor" id="subsec_dumpi_tracereplay"></a>
Trace Replay</h3>
<p>To replay a trace in the simulator, a small modification is required to the example input file in <a class="el" href="page_ParamsTutorial.html#sec_parameters">SST/macro Parameter files</a>. We have two choices for the trace replay. First, we can attempt to <em>exactly</em> replay the trace as it ran on the host machine. Second, we could replay the trace on a new machine or different layout.</p>
<p>For exact replay, the key issue is specifying the machine topology. For some architectures, topology information can be directly encoded into the trace. This is generally true on Blue Gene, but not Cray. When topology information is recorded, trace replay is much easier. The parameter file then becomes, e.g.</p>
<div class="fragment"><div class="line">launch_app1_type = dumpi</div>
<div class="line">launch_indexing = dumpi</div>
<div class="line">launch_allocation = dumpi</div>
<div class="line">launch_app1 = parsedumpi</div>
<div class="line">launch_dumpi_metaname = testbgp.meta</div>
</div><!-- fragment --><p> We have a new parameter <code>launch_app1_type</code> set to <code>dumpi</code>. This was implicit before, taking the default value of <code>skeleton</code>. We also set indexing and allocation parameters to read from the DUMPI trace. The application name in <code>launch_app1</code> is a special app that parses the DUMPI trace. Finally, we direct SST/macro to the DUMPI metafile produced when the trace was collected. To extract the topology information, locate the <code>.bin</code> file corresponding to MPI rank 0. To print topology info, run</p>
<div class="fragment"><div class="line">dumpi2ascii -H testbgp-0000.bin</div>
</div><!-- fragment --><p> which produces the output</p>
<div class="fragment"><div class="line">version=1.1.0</div>
<div class="line">starttime=Fri Nov 22 13:53:58 2013</div>
<div class="line">hostname=R00-M1-N01-J01.challenger</div>
<div class="line">username=&lt;none&gt;</div>
<div class="line">meshdim=3</div>
<div class="line">meshsize=[4, 2, 2]</div>
<div class="line">meshcrd=[0, 0, 0]</div>
</div><!-- fragment --><p> Here we see that the topology is 3D with extent 4,2,2 in the X,Y,Z directions. At present, the user must still specify the topology in the parameter file. Even though SST/macro can read the topology <em>dimensions</em> from the trace file, it cannot read the topology <em>type</em>. It could be a torus, dragonfly, or fat tree. The parameter file therefore needs</p>
<div class="fragment"><div class="line">topology_name = hdtorus</div>
<div class="line">topology_geometry = 4 2 2</div>
</div><!-- fragment --><p> Beyond the topology, the user must also specify the machine model with bandwidth and latency parameters. Again, this is information that cannot be automatically encoded in the trace. It must be determined via small benchmarks like ping-pong. An example file can be found in the test suite in <code>tests/test_configs/testdumpibgp.ini</code>.</p>
<p>If no topology info could be recorded in the trace, more work is needed. The only information recorded in the trace is the hostname of each MPI rank. The parameters are almost the same, but with allocation now set to <code>hostname</code>. Since no topology info is contained in the trace, a hostname map must be put into a text file that maps a hostname to the topology coordinates. The new parameter file, for a fictional machine called deep thought</p>
<div class="fragment"><div class="line"><span class="preprocessor"># Launch parameters</span></div>
<div class="line"><span class="preprocessor"></span>launch_app1_type = dumpi</div>
<div class="line">launch_indexing = dumpi</div>
<div class="line">launch_allocation = hostname</div>
<div class="line">launch_app1 = parsedumpi</div>
<div class="line">launch_dumpi_metaname = dumpi-2013.09.26.10.55.53.meta</div>
<div class="line">launch_dumpi_mapname = deepthought.map</div>
<div class="line"><span class="preprocessor"># Machine parameters</span></div>
<div class="line"><span class="preprocessor"></span>topology_name = torus</div>
<div class="line">topology_geometry = 2 2</div>
</div><!-- fragment --><p>In this case, we assume a 2D torus with four nodes. Again, DUMPI records the hostname of each MPI rank during trace collection. In order to replay the trace, the mapping of hostname to coordinates must be given in a node map file, specified by the parameter <code>launch_dumpi_mapname</code>. The node map file has the format</p>
<div class="fragment"><div class="line">4 2</div>
<div class="line">nid0 0 0</div>
<div class="line">nid1 0 1</div>
<div class="line">nid2 1 0</div>
<div class="line">nid3 1 1</div>
</div><!-- fragment --><p> where the first line gives the number of nodes and number of coordinates, respectively. Each hostname and its topology coordinates must then be specified. More details on building hostname maps are given below.</p>
<p>We can also use the trace to experiment with new topologies to see performance changes. Suppose we want to test a crossbar topology.</p>
<div class="fragment"><div class="line"><span class="preprocessor"># Launch parameters</span></div>
<div class="line"><span class="preprocessor"></span>launch_indexing = block</div>
<div class="line">launch_allocation = first_available</div>
<div class="line">launch_app1 = parsedumpi</div>
<div class="line">launch_app1_size = 2</div>
<div class="line">launch_dumpi_metaname = dumpi-2013.09.26.10.55.53.meta</div>
<div class="line"><span class="preprocessor"># Machine parameters</span></div>
<div class="line"><span class="preprocessor"></span>topology_name = crossbar</div>
<div class="line">topology_geometry = 4</div>
</div><!-- fragment --><p> We no longer use the DUMPI allocation and indexing. We also no longer require a hostname map. The trace is only used to generate MPI events and no topology or hostname data is used. The MPI ranks are mapped to physical nodes entirely independent of the trace.</p>
<h3><a class="anchor" id="subsec_dumpi_hostnamemap"></a>
Building the Hostname Map</h3>
<p>Not all HPC machines support topology queries. The current scheme is only valid for Cray machines, which support topology queries via <code>xtdb2proc</code>. NOTE: As of 01/15/2014, this command seems to be broken at NERSC. SST/macro comes with a script in the bin folder, <code>xt2nodemap.pl</code>, that parses the Cray file into the DUMPI format. We first run</p>
<div class="fragment"><div class="line">xtdb2proc -f - &gt; db.txt</div>
</div><!-- fragment --><p> to generate a Cray-formatted file <code>db.txt</code>. Next we run the conversion script</p>
<div class="fragment"><div class="line">xt2nodemap.pl -t hdtorus &lt; db.txt &gt; nodemap.txt</div>
</div><!-- fragment --><p> generating the hostname map. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Sep 16 2016 16:24:38 for SST/macro by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
